<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LMS - Tasks</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <nav id="main-nav"></nav>

  <main>
    <h1>Tasks</h1>

    <div class="card">
      <h2>Add Task</h2>
      <div id="task-alert" class="alert alert-error"></div>
      <div class="row" style="align-items:flex-end;">
        <div class="form-group" style="flex:2; margin-bottom:0;">
          <label>Title</label>
          <input type="text" id="t-title" placeholder="Task title"/>
        </div>
        <div class="form-group" style="flex:1; margin-bottom:0;">
          <label>Due Date</label>
          <input type="date" id="t-date"/>
        </div>
        <div class="form-group" style="flex:1; margin-bottom:0;">
          <label>Priority</label>
          <select id="t-priority">
            <option value="High">High</option>
            <option value="Medium" selected>Medium</option>
            <option value="Low">Low</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="addTask()" style="flex-shrink:0;">Add</button>
      </div>
    </div>

    <div class="row" style="margin-bottom:12px;">
      <input type="text" id="search" placeholder="Search tasks..." style="max-width:260px;" oninput="render()"/>
      <select id="sort-by" style="max-width:160px;" onchange="render()">
        <option value="">Sort by...</option>
        <option value="priority">Priority</option>
        <option value="date">Due Date</option>
      </select>
    </div>

    <h2>Tasks <span id="task-count" style="font-size:12px; color:#777;"></span></h2>
    <div id="task-list"></div>
  </main>

  <script src="nav.js"></script>
  <script>
    renderNav('tasks');

    const PORDER = { High: 0, Medium: 1, Low: 2 };

    function getTasks()      { return JSON.parse(localStorage.getItem('lms_tasks') || '[]'); }
    function saveTasks(arr)  { localStorage.setItem('lms_tasks', JSON.stringify(arr)); }

    function addTask() {
      const title    = document.getElementById('t-title').value.trim();
      const date     = document.getElementById('t-date').value;
      const priority = document.getElementById('t-priority').value;
      const alertEl  = document.getElementById('task-alert');

      if (!title || !date) {
        alertEl.textContent = 'Title and Due Date are required.';
        alertEl.classList.add('show');
        return;
      }
      alertEl.classList.remove('show');

      const tasks = getTasks();
      tasks.push({ id: Date.now(), title, date, priority, done: false });
      saveTasks(tasks);
      document.getElementById('t-title').value = '';
      document.getElementById('t-date').value  = '';
      render();
    }

    function toggleDone(id) {
      saveTasks(getTasks().map(t => t.id === id ? { ...t, done: !t.done } : t));
      render();
    }

    function deleteTask(id) {
      if (!confirm('Delete this task?')) return;
      saveTasks(getTasks().filter(t => t.id !== id));
      render();
    }

    function esc(s) {
      return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function render() {
      const q    = document.getElementById('search').value.toLowerCase();
      const sort = document.getElementById('sort-by').value;

      let list = getTasks().filter(t => t.title.toLowerCase().includes(q));

      if (sort === 'priority') list.sort((a,b) => PORDER[a.priority] - PORDER[b.priority]);
      if (sort === 'date')     list.sort((a,b) => new Date(a.date) - new Date(b.date));

      document.getElementById('task-count').textContent = '(' + list.length + ')';

      const el = document.getElementById('task-list');
      if (!list.length) { el.innerHTML = '<div class="empty">No tasks found.</div>'; return; }

      el.innerHTML = list.map(t => `
        <div class="item ${t.done ? 'done' : ''}">
          <span class="item-title">${esc(t.title)}</span>
          <span class="priority-${t.priority.toLowerCase()}">${t.priority}</span>
          <span class="item-meta">${t.date}</span>
          <span class="${t.done ? 'status-done' : 'status-pending'}">${t.done ? 'Done' : 'Pending'}</span>
          <div class="item-actions">
            <button class="btn ${t.done ? 'btn-gray' : 'btn-success'}" onclick="toggleDone(${t.id})">
              ${t.done ? 'Undo' : 'Mark Complete'}
            </button>
            <button class="btn btn-danger" onclick="deleteTask(${t.id})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    render();
    document.getElementById('t-title').addEventListener('keydown', e => { if (e.key === 'Enter') addTask(); });
  </script>
</body>
</html>
